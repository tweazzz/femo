<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="/dist/style.css" rel="stylesheet" />
    <script defer src="src/scripts/showpass.js"></script>
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
  </head>

  <body class="bg-gray-background">
    <div class="mx-auto my-8 max-w-lg rounded-3xl bg-white p-5 shadow-md">

      <div class="mb-2 text-center text-2xl font-bold">
        <p>–†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ üëã</p>
      </div>

      <div class="text-primary mb-6 rounded-lg text-center text-sm">
        –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è —Ç–≤–æ–µ–≥–æ —É—Ä–æ–≤–Ω—è
      </div>

      <form class="space-y-6">
        <br>
        <div>
            <label for="city" class="text-gray-primary mb-1 block text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–≤</label>
            <input
              type="text"
              id="city"
              name="city"
              placeholder="–ê–ª–º–∞—Ç—ã"
              class="input-base border-default w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400"
            />
        </div>
        <div>
          <label class="text-gray-primary mb-1 block text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∫–æ–ª—ã</label>
          <input name="school"
            placeholder="–û–±—â–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —à–∫–æ–ª–∞ ‚Ññ16 –∏–º. –ê. –®–∞—Ä–∏–ø–æ–≤–∞"
            class="input-base border-default"
          />
        </div>
        <div>
            <label for="grade" class="text-gray-primary mb-1 block text-sm">–ö–ª–∞—Å—Å</label>
            <select
              id="grade"
              name="grade"
              class="input-base border-default w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400"
            >
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
            </select>
        </div>
        <div class="border-default rounded-2xl">
            <p class="mb-3 text-sm">–Ø–∑—ã–∫ –æ–±—É—á–µ–Ω–∏—è</p>
          
            <div class="flex flex-wrap items-start justify-start gap-4">
              <label class="switch-btn flex items-center gap-2 cursor-pointer">
                <img
                  src="https://flagcdn.com/w40/ru.png"
                  alt="–§–ª–∞–≥ –†–æ—Å—Å–∏–∏"
                  class="h-3 w-5 object-contain"
                />
                <input
                  type="radio"
                  name="lang"
                  value="ru"
                  class="hidden"
                  required
                  checked
                />
                –†—É—Å—Å–∫–∏–π
              </label>
          
              <label class="switch-btn flex items-center gap-2 cursor-pointer">
                <img
                  src="https://flagcdn.com/w40/kz.png"
                  alt="–§–ª–∞–≥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞"
                  class="h-3 w-5 object-contain"
                />
                <input
                  type="radio"
                  name="lang"
                  value="kz"
                  class="hidden"
                  required
                />
                “ö–∞–∑–∞“õ—à–∞
              </label>
          
              <label class="switch-btn flex items-center gap-2 cursor-pointer">
                <img
                  src="https://flagcdn.com/w40/gb.png"
                  alt="–§–ª–∞–≥ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏"
                  class="h-3 w-5 object-contain"
                />
                <input
                  type="radio"
                  name="lang"
                  value="en"
                  class="hidden"
                  required
                />
                English
              </label>
            </div>
        </div>
                    
        <div>
          <label class="text-gray-primary mb-1 block text-sm">–§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è</label>
          <input
            type="text" name="full_name"
            placeholder="–ê–π–∂–∞–Ω –ê—Ö–º–µ—Ç–æ–≤–∞"
            class="input-base border-default"
          />
        </div>
        <div>
            <label class="text-gray-primary mb-1 block text-sm">–¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–¥–∏—Ç–µ–ª—è</label>
            <input
              type="tel"
              name="parent_phone"
              placeholder="+7 (___) ___-__-__"
              class="input-base border-default"
            />
        </div>
        <!-- –§–ò–û —É—á–∏—Ç–µ–ª—è -->
        <div>
            <label class="text-gray-primary mb-1 block text-sm">–§–ò–û —É—á–∏—Ç–µ–ª—è</label>
            <input
            type="text"
            name="teacher_full_name"
            placeholder="–ì—É–ª—å–º–∏—Ä–∞ –ê–±–¥—Ä–∞—Ö–º–∞–Ω–æ–≤–∞"
            class="input-base border-default"
            />
        </div>
        
        <!-- –¢–µ–ª–µ—Ñ–æ–Ω –∏ Email —É—á–∏—Ç–µ–ª—è –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
            <label class="text-gray-primary mb-1 block text-sm">–¢–µ–ª–µ—Ñ–æ–Ω —É—á–∏—Ç–µ–ª—è</label>
            <input
                type="tel"
                name="teacher_phone"
                placeholder="+7 (___) ___-__-__"
                class="input-base border-default w-full"
            />
            </div>
        
            <div class="flex-1">
            <label class="text-gray-primary mb-1 block text-sm">Email —É—á–∏—Ç–µ–ª—è</label>
            <input
                type="email"
                name="teacher_email"
                placeholder="teacher@example.com"
                class="input-base border-default w-full"
            />
            </div>
        </div>
  

        <button
          type="submit"
          class="bg-orange-primary w-full cursor-pointer rounded-xl py-2 text-white transition"
        >
            –ù–∞—á–∞—Ç—å —É—á–∏—Ç—å—Å—è
        </button>

      </form>

    </div>
  </body>
</html>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form.space-y-6');
      const submitBtn = form.querySelector('button[type="submit"]');
    
      // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —á–∏—Å–ª–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ —Å–ª–æ–≤–µ—Å–Ω—ã–π (–µ—Å–ª–∏ API –æ–∂–∏–¥–∞–µ—Ç —Ç–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏)
      const gradeMap = {
        '1': 'first',
        '2': 'second',
        '3': 'third',
        '4': 'fourth',
        '5': 'fifth',
        '6': 'sixth',
        '7': 'seventh',
        '8': 'eighth',
        '9': 'ninth',
        '10': 'tenth',
        '11': 'eleventh'
      };
    
      function showError(message) {
        alert(message);
      }
    
      function getAccessTokenFromLocalStorage() {
        // 1) –ø—Ä—è–º–æ–π –∫–ª—é—á access_token
        let token = localStorage.getItem('access_token') || localStorage.getItem('token');
        if (token) return token;
    
        // 2) –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏—Ç—å localStorage.user –∏ –≤–∑—è—Ç—å common –ø–æ–ª—è (access, access_token, token)
        try {
          const raw = localStorage.getItem('user') || localStorage.getItem('auth') || null;
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          return parsed?.access_token || parsed?.access || parsed?.token || null;
        } catch (e) {
          return null;
        }
      }
    
      async function sendProfile(payload) {
        const url = 'https://portal.femo.kz/api/users/participant/profile/';
    
        const token = getAccessTokenFromLocalStorage();
        if (!token) {
          throw new Error('no_token');
        }
    
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };
    
        const resp = await fetch(url, {
          method: 'PUT',
          headers,
          body: JSON.stringify(payload),
          // credentials: 'include' // –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è cookie-based auth ‚Äî –≤–∫–ª—é—á–∏
        });
    
        return resp;
      }
    
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        const originalText = submitBtn.innerText;
        submitBtn.innerText = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
    
        try {
          const city = (form.querySelector('input[name="city"]')?.value || '').trim();
          const school = (form.querySelector('input[name="school"]')?.value || '').trim();
          const gradeValue = (form.querySelector('select[name="grade"]')?.value || '').trim();
          const studyLanguage = (form.querySelector('input[name="lang"]:checked')?.value || '').trim();
    
          const parentName = (form.querySelector('input[name="full_name"]')?.value || '').trim();
          const parentPhone = (form.querySelector('input[name="parent_phone"]')?.value || '').trim();
    
          const teacherName = (form.querySelector('input[name="teacher_full_name"]')?.value || '').trim();
          const teacherPhone = (form.querySelector('input[name="teacher_phone"]')?.value || '').trim();
          // const teacherEmail = (form.querySelector('input[name="teacher_email"]')?.value || '').trim();
    
          // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
          if (!city) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥.'); throw new Error('validation'); }
          if (!school) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —à–∫–æ–ª—É.'); throw new Error('validation'); }
          if (!gradeValue) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å.'); throw new Error('validation'); }
          if (!studyLanguage) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –æ–±—É—á–µ–Ω–∏—è.'); throw new Error('validation'); }
          if (!parentName) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è.'); throw new Error('validation'); }
          if (!parentPhone) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–æ–¥–∏—Ç–µ–ª—è.'); throw new Error('validation'); }
          if (!teacherName) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –§–ò–û —É—á–∏—Ç–µ–ª—è.'); throw new Error('validation'); }
          if (!teacherPhone) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —É—á–∏—Ç–µ–ª—è.'); throw new Error('validation'); }
    
          const grade = gradeMap[gradeValue] || gradeValue;
    
          const body = {
            city: city,
            school: school,
            grade: grade,
            study_language: studyLanguage,
            parent: {
              name_ru: parentName,
              phone_number: parentPhone
            },
            teacher: {
              name_ru: teacherName,
              phone_number: teacherPhone
            }
          };
    
          let resp;
          try {
            resp = await sendProfile(body);
          } catch (err) {
            if (err.message === 'no_token') {
              showError('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage. –ù—É–∂–µ–Ω access_token –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
              return;
            }
            throw err;
          }
    
          if (resp.ok) {
            window.location.href = '/participant/dashboard.html';
            return;
          } else {
            let errText = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`;
            try {
              const json = await resp.json();
              if (typeof json === 'object' && json !== null) {
                const msgs = [];
                for (const key in json) {
                  if (Array.isArray(json[key])) msgs.push(`${key}: ${json[key].join(', ')}`);
                  else if (typeof json[key] === 'object') msgs.push(`${key}: ${JSON.stringify(json[key])}`);
                  else msgs.push(`${key}: ${String(json[key])}`);
                }
                if (msgs.length) errText = msgs.join('\n');
                else errText = JSON.stringify(json);
              } else {
                errText = String(json);
              }
            } catch (parseErr) {
              // –æ—Å—Ç–∞–≤–∏–º –±–∞–∑–æ–≤—ã–π errText
            }
            showError(errText);
          }
        } catch (err) {
          if (err.message !== 'validation') {
            console.error(err);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerText = originalText;
        }
      });
    });
</script>
    
    
    
    
